<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weed Breed ‚Äì Struktur‚ÄëBrowser Clickdummy (v4)</title>
  <style>
    :root { --bg:#0f1115; --panel:#151924; --panel-2:#1a1f2e; --txt:#e6e9f0; --muted:#9aa3b2; --accent:#6ee7b7; --accent-2:#60a5fa; --danger:#f87171; --ok:#34d399; --radius:14px; --gap:12px; }
    @media (prefers-color-scheme: light) { :root { --bg:#f6f8fc; --panel:#fff; --panel-2:#f2f4f8; --txt:#111827; --muted:#4b5563; } }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, #1b2030 0%, var(--bg) 50%) fixed;color:var(--txt);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial}

    /* Layout 25/75 */
    .app{display:grid;grid-template-columns:25% 75%;min-height:100dvh}

    /* Left: Pane with Ribbon + Tree */
    .browser{background:linear-gradient(180deg,var(--panel-2),var(--panel));border-right:1px solid #2b3243;padding:14px;position:sticky;top:0;align-self:start;height:100dvh;overflow:auto}
    .brand{display:flex;align-items:center;gap:10px;padding:10px;margin:0 0 8px}
    .logo{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 45deg,var(--accent),var(--accent-2));box-shadow:0 0 0 2px #0005 inset}
    .brand h1{font-size:16px;margin:0}

    /* Ribbon (Tree Switcher) */
    .ribbon{display:flex;gap:6px;margin:6px 0 10px}
    .rbtn{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid #2b3243;background:transparent;color:var(--muted);cursor:pointer}
    .rbtn[aria-pressed="true"]{background:#ffffff14;color:var(--txt);border-color:#ffffff2a}

    .search{display:flex;gap:8px;margin:8px 0 6px}
    .search input{flex:1;padding:8px 10px;border-radius:10px;border:1px solid #2b3243;background:var(--panel-2);color:var(--txt)}
    .filters{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
    .chip{padding:6px 8px;border-radius:999px;border:1px solid #2b3243;background:transparent;color:var(--muted);cursor:pointer}
    .chip[aria-pressed="true"]{background:#ffffff12;color:var(--txt)}

    /* Tree */
    .tree{list-style:none;margin:8px 0 0;padding:0}
    .node{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;cursor:pointer;border:1px solid transparent}
    .node:hover{background:#ffffff0a;border-color:#ffffff12}
    .node[aria-selected="true"]{background:#ffffff12;border-color:#ffffff2a}
    .node .title{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .badge{margin-left:auto;font-size:12px;padding:2px 8px;border-radius:999px;background:#ffffff12;color:var(--muted)}
    .children{margin-left:20px;border-left:1px dashed #2b3243;padding-left:8px}
    .twisty{width:14px;text-align:center;opacity:.8}

    /* Right: Content */
    main{padding:16px}
    .topbar{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin-bottom:12px}
    .sim-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:10px;border:1px solid #2b3243;background:var(--panel-2);color:var(--txt);cursor:pointer}
    .btn.primary,.btn[aria-pressed="true"]{background:linear-gradient(180deg,#293145,#1d2333);border-color:#3b445e}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .clock{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:12px;background:var(--panel-2);border:1px solid #2b3243}
    .clock .dot{width:8px;height:8px;border-radius:50%;background:var(--danger);box-shadow:0 0 0 4px #f8717122}
    .clock.running .dot{background:var(--ok);box-shadow:0 0 0 4px #34d39922}

    /* Balance chip (always visible) */
    .finance{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;background:var(--panel-2);border:1px solid #2b3243}
    .finance .label{color:var(--muted)}
    .finance .value{font-weight:600}

    /* Breadcrumbs */
    .crumbs{display:flex;gap:8px;align-items:center;margin:0 0 12px}
    .crumbs a{color:var(--txt);text-decoration:none;padding:6px 8px;border-radius:8px}
    .crumbs a:hover{background:#ffffff10}

    /* Cards & Tables */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
    .card{grid-column:span 4;background:linear-gradient(180deg,#1a1f2e,#141827);padding:14px;border-radius:var(--radius);border:1px solid #2b3243}
    .card h3{margin:0 0 6px;font-size:13px;color:var(--muted)}
    .metric{display:flex;align-items:baseline;gap:10px}
    .metric .v{font-size:22px;font-weight:600}
    .row{display:flex;justify-content:space-between;gap:8px;margin-top:6px;color:var(--muted);font-size:12px}
    .section{background:var(--panel);border:1px solid #2b3243;border-radius:var(--radius);padding:14px;margin-bottom:12px}
    .section header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px 8px;border-bottom:1px dashed #2b3243;text-align:left}
    th{color:var(--muted)}
    tr:hover td{background:#ffffff06}

    /* Skeletons (charts/placeholders) */
    .skeleton{height:140px;border-radius:12px;background:linear-gradient(90deg,#20263a 25%,#262d43 37%,#20263a 63%);background-size:400% 100%;animation:shimmer 1.8s infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}

    /* Responsive */
    @media (max-width:1100px){.app{grid-template-columns:100%}.browser{position:relative;height:auto}}
  </style>
</head>
<body>
  <div class="app">
    <!-- Left: Ribbon + Tree -->
    <aside class="browser" id="browser">
      <div class="brand"><div class="logo"></div><h1>Weed Breed</h1></div>
      <div class="ribbon" role="tablist" aria-label="Tree Auswahl">
        <button class="rbtn" id="rb-structure" data-mode="structure" aria-pressed="true">üèóÔ∏è Structure</button>
        <button class="rbtn" id="rb-finance" data-mode="finance" aria-pressed="false">üí∂ Finance</button>
        <button class="rbtn" id="rb-shop" data-mode="shop" aria-pressed="false">üõí Shop</button>
      </div>
      <div class="search"><input id="search" type="search" placeholder="Suche‚Ä¶ (Tree)" /></div>
      <div class="filters">
        <button class="chip" data-filter="alerts" aria-pressed="false">Nur Alerts</button>
        <button class="chip" data-filter="zones>0" aria-pressed="false">Mit Zonen</button>
        <button class="chip" data-filter="plants>0" aria-pressed="false">Mit Pflanzen</button>
      </div>
      <ul class="tree" id="tree" role="tree" aria-label="Explorer"><!-- built by JS --></ul>
    </aside>

    <!-- Right: Content -->
    <main>
      <div class="topbar">
        <div class="sim-controls" role="group" aria-label="Simulationssteuerung">
          <button class="btn" id="btn-step" title="1 Tick vor">‚è≠Ô∏è Schritt</button>
          <button class="btn primary" id="btn-play" title="Start">‚ñ∂ Start</button>
          <button class="btn" id="btn-pause" title="Pause" disabled>‚è∏ Pause</button>
          <span style="width:10px"></span>
          <button class="btn speed" data-speed="0.5" aria-pressed="false">0.5√ó</button>
          <button class="btn speed" data-speed="1" aria-pressed="true">1√ó</button>
          <button class="btn speed" data-speed="2" aria-pressed="false">2√ó</button>
          <button class="btn speed" data-speed="5" aria-pressed="false">5√ó</button>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <div id="clock" class="clock" aria-live="polite">
            <div class="dot"></div>
            <div>Tag <span id="day">1</span> ‚Ä¢ <span id="time">08:00</span> ‚Ä¢ Tick <span id="tick">0</span> ‚Ä¢ Œît <span id="tick-hours">3</span>h</div>
          </div>
          <div class="finance" title="Kontostand">
            <span class="label">Kontostand</span>
            <span class="value" id="balance-top">‚Äî</span>
          </div>
        </div>
      </div>

      <nav class="crumbs" id="crumbs"><!-- breadcrumbs --></nav>
      <div id="content"><!-- dynamic content --></div>
    </main>
  </div>

  <script type="module">
    // Helpers
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const txt = (s, v) => { const el=$(s); if(el) el.textContent = v; };
    const fmtNUM = new Intl.NumberFormat('de-DE', { maximumFractionDigits: 2 });
    const fmtEUR = new Intl.NumberFormat('de-DE', { style:'currency', currency:'EUR', maximumFractionDigits:2 });

    // Mock Data ‚Äì Structure Tree (incl. devices grouped per zone)
    const structureData = {
      structures: [
        { id:'s1', name:'Warehouse North', alerts:1, rooms:[
          { id:'r1', name:'GrowRoom#1', type:'Indoor', alerts:1, zones:[
            { id:'z1', name:'Zone A', plants:[
              { id:'p1', label:'AK‚Äë47 #1', strain:'AK‚Äë47', stage:'flower', ageDays:42, biomass_g:320, stress:0.12 },
              { id:'p2', label:'AK‚Äë47 #2', strain:'AK‚Äë47', stage:'flower', ageDays:41, biomass_g:310, stress:0.14 }
            ], devices:[
              { id:'d1', label:'Lamp #1', kind:'Lamp', powerW:480, efficiency:0.92, health:0.88, maintenanceEUR_tick:0.03 },
              { id:'d2', label:'ClimateUnit #1', kind:'AC', powerW:null, efficiency:null, health:0.90, maintenanceEUR_tick:0.02 }
            ], alerts:1 },
            { id:'z2', name:'Zone B', plants:[
              { id:'p3', label:'Mango Kush #1', strain:'Mango Kush', stage:'veg', ageDays:18, biomass_g:90, stress:0.05 }
            ], devices:[
              { id:'d3', label:'Lamp #2', kind:'Lamp', powerW:480, efficiency:0.90, health:0.86, maintenanceEUR_tick:0.03 }
            ], alerts:0 }
          ]},
          { id:'r2', name:'Lab', type:'Lab', alerts:0, zones:[] }
        ]},
        { id:'s2', name:'Outdoor Field', alerts:0, rooms:[
          { id:'r3', name:'Field#1', type:'Outdoor', alerts:0, zones:[
            { id:'z3', name:'Plot 1', plants:[
              { id:'p4', label:'SSH #1', strain:'Super Silver Haze', stage:'veg', ageDays:22, biomass_g:110, stress:0.07 }
            ], devices:[
              { id:'d4', label:'Irrigation #1', kind:'Irrigation', powerW:null, efficiency:null, health:0.95, maintenanceEUR_tick:0.01 }
            ], alerts:0 }
          ]}
        ]}
      ]
    };

    // Mock Data ‚Äì Finance & Shop Trees (simple placeholders)
    const financeData = {
      roots: [
        { id:'f1', name:'Konten', children:[
          { id:'fa1', name:'Kasse', children:[{ id:'fm1', name:'August 2025', entries:[
            { id:'e1', type:'expense', label:'Miete', amount:-1200 },
            { id:'e2', type:'expense', label:'Energie', amount:-340.5 },
            { id:'e3', type:'income', label:'Verkauf Ernte', amount:+2450 }
          ] }] } ,
          { id:'fa2', name:'Bank', children:[{ id:'fm2', name:'August 2025', entries:[ { id:'e4', type:'expense', label:'Wasser', amount:-55.2 } ] }] }
        ]},
        { id:'f2', name:'Kostenarten', children:[
          { id:'fc1', name:'Miete' }, { id:'fc2', name:'Energie' }, { id:'fc3', name:'Wasser' }, { id:'fc4', name:'Wartung' }
        ]}
      ]
    };

    const shopData = {
      categories:[
        { id:'sc1', name:'Lighting', items:[ { id:'sl1', name:'LED 480W Pro' }, { id:'sl2', name:'LED 320W Eco' } ] },
        { id:'sc2', name:'Climate', items:[ { id:'sa1', name:'AC Compact' }, { id:'sa2', name:'CO‚ÇÇ Controller' } ] },
        { id:'sc3', name:'Irrigation', items:[ { id:'si1', name:'DripKit 20' } ] },
        { id:'sc4', name:'Nutrients', items:[ { id:'sn1', name:'NPK Set A' } ] },
        { id:'sc5', name:'Seeds', items:[ { id:'ss1', name:'AK‚Äë47' }, { id:'ss2', name:'Mango Kush' } ] }
      ]
    };

    // Selection + Sim State
    const state = {
      treeMode:'structure', // 'structure' | 'finance' | 'shop'
      level:'none', structureId:null, roomId:null, zoneId:null, plantId:null,
      finSel:null, shopSel:null,
      running:false, speed:1, tick:0, tickHours:3, simTime:new Date(2025,0,1,8,0,0), balance:25000
    };

    // ---------- Build Trees --------------------------------------------------
    function buildTree(){
      const tree = $('#tree'); tree.innerHTML = '';
      if(state.treeMode==='structure') buildStructureTree(tree);
      if(state.treeMode==='finance') buildFinanceTree(tree);
      if(state.treeMode==='shop') buildShopTree(tree);
    }

    function nodeLi(kind, id, icon, title, alerts=0, count=0){
      const li = document.createElement('li'); li.setAttribute('role','treeitem');
      li.innerHTML = `<div class="node" tabindex="0" data-kind="${kind}" data-id="${id}">
        <span class="twisty">‚ñ∏</span> <span class="title">${icon} ${title}</span>
        <span class="badge" title="Z√§hler/Status">${count}${alerts?` ‚Ä¢ ‚ö†${alerts}`:''}</span>
      </div><div class="children" hidden></div>`;
      const node = li.firstElementChild; const children = li.lastElementChild;
      node.addEventListener('click', () => {
        if(children.children.length){ children.hidden = !children.hidden; node.querySelector('.twisty').textContent = children.hidden ? '‚ñ∏' : '‚ñæ'; }
        selectNode(kind, id);
      });
      node.addEventListener('keydown', e=>{ if(e.key==='Enter'){ node.click(); } });
      return li;
    }

    function buildStructureTree(root){
      structureData.structures.forEach(s => {
        const sLi = nodeLi('structure', s.id, 'üèóÔ∏è', s.name, s.alerts, s.rooms.length); const sCh = sLi.querySelector('.children');
        s.rooms.forEach(r => {
          const rLi = nodeLi('room', r.id, 'üö™', r.name, r.alerts, r.zones.length); const rCh = rLi.querySelector('.children');
          r.zones.forEach(z => {
            const zCount = (z.plants?.length||0) + (z.devices?.length||0);
            const zLi = nodeLi('zone', z.id, 'üß©', z.name, z.alerts, zCount); const zCh = zLi.querySelector('.children');
            // Devices grouped as ONE element under the zone
            const devLi = nodeLi('devices', z.id, 'üîß', `Devices (${z.devices.length})`, 0, z.devices.length);
            zCh.appendChild(devLi);
            // Plants as individual leaves
            (z.plants||[]).forEach(p => { zCh.appendChild(nodeLi('plant', p.id, 'üåø', p.label, 0, 0)); });
            rCh.appendChild(zLi);
          });
          sCh.appendChild(rLi);
        });
        root.appendChild(sLi);
      });
    }

    function buildFinanceTree(root){
      financeData.roots.forEach(g => {
        const gLi = nodeLi('finance-root', g.id, 'üí∂', g.name, 0, g.children?.length||0); const gCh=gLi.querySelector('.children');
        (g.children||[]).forEach(acc => {
          const aLi = nodeLi('finance-acc', acc.id, 'üè¶', acc.name, 0, acc.children?.length||0); const aCh=aLi.querySelector('.children');
          (acc.children||[]).forEach(month => {
            const mLi = nodeLi('finance-month', month.id, 'üóìÔ∏è', month.name, 0, month.entries?.length||0);
            aCh.appendChild(mLi);
          });
          gCh.appendChild(aLi);
        });
        root.appendChild(gLi);
      });
    }

    function buildShopTree(root){
      shopData.categories.forEach(cat => {
        const cLi = nodeLi('shop-cat', cat.id, 'üõí', cat.name, 0, cat.items?.length||0); const cCh=cLi.querySelector('.children');
        (cat.items||[]).forEach(item => { cCh.appendChild(nodeLi('shop-item', item.id, 'üì¶', item.name, 0, 0)); });
        root.appendChild(cLi);
      });
    }

    // ---------- Selection + Breadcrumbs -------------------------------------
    function selectNode(kind, id){
      // Reset structure selection when switching trees
      if(state.treeMode==='structure'){
        state.level = kind;
        if (kind==='structure'){ state.structureId=id; state.roomId=null; state.zoneId=null; state.plantId=null; }
        if (kind==='room'){ state.roomId=id; state.zoneId=null; state.plantId=null; const s = findStructureOfRoom(id); state.structureId=s?.id||null; }
        if (kind==='zone'){ state.zoneId=id; state.plantId=null; const {s,r} = findParentsOfZone(id) || {}; state.structureId=s?.id||null; state.roomId=r?.id||null; }
        if (kind==='devices'){ state.zoneId=id; const {s,r} = findParentsOfZone(id) || {}; state.structureId=s?.id||null; state.roomId=r?.id||null; }
        if (kind==='plant'){ state.plantId=id; const p = findParentsOfPlant(id); state.structureId=p?.s?.id||null; state.roomId=p?.r?.id||null; state.zoneId=p?.z?.id||null; }
      }
      if(state.treeMode==='finance'){ state.finSel = { kind, id }; state.level = kind; }
      if(state.treeMode==='shop'){ state.shopSel = { kind, id }; state.level = kind; }

      // Visual selection
      $$('#tree .node').forEach(n=>n.setAttribute('aria-selected','false'));
      const current = $(`#tree .node[data-kind="${kind}"][data-id="${id}"]`); if(current) current.setAttribute('aria-selected','true');
      renderBreadcrumbs();
      renderContent();
      location.hash = `#/${state.treeMode}/${state.structureId||''}/${state.roomId||''}/${state.zoneId||''}/${state.plantId||''}`;
    }

    function findStructure(id){ return structureData.structures.find(s=>s.id===id); }
    function findStructureOfRoom(roomId){ return structureData.structures.find(s=>s.rooms.some(r=>r.id===roomId)); }
    function findParentsOfZone(zoneId){
      for(const s of structureData.structures){ for(const r of s.rooms){ const z = r.zones.find(z=>z.id===zoneId); if(z) return {s,r,z}; } }
      return null;
    }
    function findParentsOfPlant(plantId){
      for(const s of structureData.structures){ for(const r of s.rooms){ for(const z of r.zones){ const p=z.plants?.find(p=>p.id===plantId); if(p) return {s,r,z,p}; } } }
      return null;
    }

    function renderBreadcrumbs(){
      const c = $('#crumbs'); c.innerHTML = '';
      if(state.treeMode==='structure'){
        const parts = [];
        if(state.structureId){ const s=findStructure(state.structureId); if(s) parts.push({label:s.name, kind:'structure', id:s.id}); }
        if(state.roomId){ const s=findStructureOfRoom(state.roomId); const r=s?.rooms.find(r=>r.id===state.roomId); if(r) parts.push({label:r.name, kind:'room', id:r.id}); }
        if(state.zoneId){ const p=findParentsOfZone(state.zoneId); const z=p?.z; if(z) parts.push({label:z.name, kind:'zone', id:z.id}); }
        if(state.level==='devices'){ parts.push({label:'Devices', kind:'devices', id:state.zoneId}); }
        if(state.plantId){ const p=findParentsOfPlant(state.plantId); if(p?.p) parts.push({label:p.p.label, kind:'plant', id:p.p.id}); }
        if(!parts.length) { c.innerHTML = '<span style="color:var(--muted)">Bitte links ein Element w√§hlen‚Ä¶</span>'; return; }
        parts.forEach((p,i)=>{ const a=document.createElement('a'); a.href='javascript:void(0)'; a.textContent=p.label; a.addEventListener('click',()=>selectNode(p.kind,p.id)); c.appendChild(a); if(i<parts.length-1){ const s=document.createElement('span'); s.textContent='‚Ä∫'; s.style.color='var(--muted)'; s.style.margin='0 4px'; c.appendChild(s); } });
      } else {
        const label = state.treeMode==='finance' ? 'Finance Explorer' : 'Shop Explorer';
        c.innerHTML = `<strong>${label}</strong>`;
      }
    }

    // ---------- Content Rendering (no tabs, context sensitive) ---------------
    function renderContent(){
      const root = $('#content'); root.innerHTML = '';
      if(state.treeMode==='structure') return renderStructureContent(root);
      if(state.treeMode==='finance') return renderFinanceContent(root);
      if(state.treeMode==='shop') return renderShopContent(root);
    }

    function section(title, inner){ const el=document.createElement('div'); el.className='section'; el.innerHTML = `<header><h3>${title}</h3></header>` + inner; return el; }
    function table(rows){ return `<table>${rows.map((row,i)=> i?`<tr>${row.map(cell=>`<td>${cell}</td>`).join('')}</tr>`:`<thead><tr>${row.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>`).join('')}</tbody></table>`; }
    function card(title, value, sub=''){ const el=document.createElement('div'); el.className='card'; el.innerHTML = `<h3>${title}</h3><div class="metric"><div class="v">${value}</div><div class="sub">${sub}</div></div>`; return el; }
    function link(target,label){ return `<a href="#" data-jump="${target}">${label}</a>`; }

    function renderStructureContent(root){
      const level = state.level;
      // Header
      const header = document.createElement('div'); header.className='section';
      let title='√úbersicht', subtitle='W√§hle links ein Element';
      if(level==='structure'){ const s=findStructure(state.structureId); title = s?.name || 'Structure'; subtitle = `${s?.rooms.length||0} Rooms`; }
      if(level==='room'){ const s=findStructureOfRoom(state.roomId); const r=s?.rooms.find(r=>r.id===state.roomId); title = r?.name || 'Room'; subtitle = `${r?.zones.length||0} Zones`; }
      if(level==='zone'){ const p=findParentsOfZone(state.zoneId); title = p?.z?.name || 'Zone'; subtitle = `${p?.z?.plants?.length||0} Plants ‚Ä¢ ${p?.z?.devices?.length||0} Devices`; }
      if(level==='devices'){ const p=findParentsOfZone(state.zoneId); title = `${p?.z?.name||'Zone'} ¬∑ Devices`; subtitle = `${p?.z?.devices?.length||0} Ger√§te`; }
      if(level==='plant'){ const p=findParentsOfPlant(state.plantId); title = p?.p?.label || 'Plant'; subtitle = `${p?.p?.strain||'‚Äî'} ‚Ä¢ ${p?.p?.stage||'‚Äî'}`; }
      header.innerHTML = `<header style="display:flex;justify-content:space-between;align-items:center"><div><strong>${title}</strong><div style="color:var(--muted);font-size:12px">${subtitle}</div></div><div class="badge">Kontext: ${level}</div></header>`;
      root.appendChild(header);

      // ‚ö†Ô∏è IMPORTANT for tests: In Devices view, the first <h3> must be the Devices section
      if(level==='devices'){
        const p=findParentsOfZone(state.zoneId);
        root.appendChild(section('Devices', table([
          ['Device','Kind','Power','Effizienz','Health','Wartung'],
          ...p.z.devices.map(d=>[d.label, d.kind, d.powerW?`${d.powerW} W`:'‚Äî', d.efficiency??'‚Äî', d.health??'‚Äî', `${fmtEUR.format(d.maintenanceEUR_tick)}/Tick`])
        ])));
      }

      // KPI row (NO balance card here)
      const kpis = document.createElement('div'); kpis.className='grid';
      if(level==='structure'){
        const s=findStructure(state.structureId); const counts = s.rooms.reduce((acc,r)=>{ acc.rooms++; acc.zones+=r.zones.length; acc.plants+=r.zones.reduce((p,z)=>p+(z.plants?.length||0),0); acc.devices+=r.zones.reduce((d,z)=>d+(z.devices?.length||0),0); return acc; }, {rooms:0,zones:0,plants:0,devices:0});
        kpis.appendChild(card('Aktive Alerts', s.alerts||0, 'gesamt'));
        kpis.appendChild(card('Rooms', counts.rooms, 'in Structure'));
        kpis.appendChild(card('Zones', counts.zones, 'in Structure'));
      }
      if(level==='room'){
        const s=findStructureOfRoom(state.roomId); const r=s.rooms.find(r=>r.id===state.roomId);
        const plants = r.zones.reduce((p,z)=>p+(z.plants?.length||0),0); const devices=r.zones.reduce((d,z)=>d+(z.devices?.length||0),0);
        kpis.appendChild(card('Zones', r.zones.length, 'im Room'));
        kpis.appendChild(card('Plants', plants, 'gesamt'));
        kpis.appendChild(card('Devices', devices, 'gesamt'));
      }
      if(level==='zone'){
        kpis.appendChild(card('Temp', '24.1 ¬∞C','Soll 24'));
        kpis.appendChild(card('RH','62 %','Soll 55‚Äì65'));
        kpis.appendChild(card('PPFD','650','Soll 600‚Äì800'));
      }
      if(level==='devices'){
        const p=findParentsOfZone(state.zoneId); const list=p.z.devices;
        const avgHealth = list.length ? (list.reduce((a,d)=>a+(d.health||0),0)/list.length) : 0;
        const maint = list.reduce((a,d)=>a+(d.maintenanceEUR_tick||0),0);
        kpis.appendChild(card('Ger√§te gesamt', list.length, 'in Zone'));
        kpis.appendChild(card('√ò Health', fmtNUM.format(avgHealth), '0‚Äì1'));
        kpis.appendChild(card('Wartung/Tick', fmtEUR.format(maint), 'Summe'));
      }
      if(level==='plant'){
        const {p} = findParentsOfPlant(state.plantId) || {}; 
        kpis.appendChild(card('Age', p?`${p.ageDays} d`:'‚Äî', 'Tage'));
        kpis.appendChild(card('Biomasse', p?`${p.biomass_g} g`:'‚Äî', 'gesch√§tzt'));
        kpis.appendChild(card('Stress', p?.stress??'‚Äî', '0‚Äì1'));
      }
      if(level!=='none') root.appendChild(kpis);

      // Context detail blocks (no devices table in zone view; use devices level)
      if(level==='structure'){
        const s=findStructure(state.structureId);
        root.appendChild(section('Rooms in Structure', table([
          ['Room','Zones','Plants','Devices','Alerts'],
          ...s.rooms.map(r=>[link(`room:${r.id}`, r.name), r.zones.length,
            r.zones.reduce((p,z)=>p+(z.plants?.length||0),0), r.zones.reduce((d,z)=>d+(z.devices?.length||0),0), r.alerts?`‚ö† ${r.alerts}`:'‚Äî'])
        ])));
        root.appendChild(section('Verlauf (mock)', `<div class="skeleton"></div>`));
      }
      if(level==='room'){
        const s=findStructureOfRoom(state.roomId); const r=s.rooms.find(r=>r.id===state.roomId);
        root.appendChild(section('Zones in Room', table([
          ['Zone','Plants','Devices','Alerts'],
          ...r.zones.map(z=>[link(`zone:${z.id}`, z.name), z.plants.length, z.devices.length, z.alerts?`‚ö† ${z.alerts}`:'‚Äî'])
        ])));
      }
      if(level==='zone'){
        const p=findParentsOfZone(state.zoneId);
        root.appendChild(section('Navigiere zu‚Ä¶', `<ul style="margin:0;padding-left:16px">
          <li>${link(`devices:${p.z.id}`, 'Devices')}</li>
          ${p.z.plants.map(pl=>`<li>${link(`plant:${pl.id}`, pl.label)}</li>`).join('')}
        </ul>`));
      }
      if(level==='plant'){
        const {p} = findParentsOfPlant(state.plantId) || {};
        root.appendChild(section('Plant Details', table([
          ['Feld','Wert'],
          ['Label', p?.label||'‚Äî'],
          ['Strain', p?.strain||'‚Äî'],
          ['Phase', p?.stage||'‚Äî'],
          ['Alter', p?`${p.ageDays} d`:'‚Äî'],
          ['Biomasse', p?`${p.biomass_g} g`:'‚Äî'],
          ['Stress', p?.stress??'‚Äî']
        ])));
      }

      // Delegate jumps
      root.addEventListener('click', (e)=>{
        const a = e.target.closest('a[data-jump]'); if(!a) return; e.preventDefault();
        const [kind,id] = a.getAttribute('data-jump').split(':'); selectNode(kind,id);
      }, { once:true });
    }

    function renderFinanceContent(root){
      // Simple placeholder content for the finance explorer
      root.appendChild(section('Finance √úbersicht', `<div class="grid">
        ${card('Buchungen (Monat)', 12, 'August 2025').outerHTML}
        ${card('OpEx (Monat)', fmtEUR.format(1598.7), 'Mock').outerHTML}
        ${card('Einnahmen (Monat)', fmtEUR.format(2450), 'Mock').outerHTML}
      </div>`));
      root.appendChild(section('Hinweis', '<p>Dies ist ein Clickdummy. Hier erscheint sp√§ter der Finanz‚ÄëBaum mit Konten, Monaten und Buchungen.</p>'));
    }

    function renderShopContent(root){
      root.appendChild(section('Shop √úbersicht', `<div class="grid">
        ${card('Kategorien', shopData.categories.length, 'Mock').outerHTML}
        ${card('Top‚ÄëArtikel', 3, 'Mock').outerHTML}
        ${card('Warenkorb', fmtEUR.format(0), 'leer').outerHTML}
      </div>`));
      root.appendChild(section('Hinweis', '<p>Dies ist ein Clickdummy. Hier erscheint sp√§ter der Shop‚ÄëBaum mit Kategorien und Artikeln.</p>'));
    }

    // ---------- Sim header mock ---------------------------------------------
    let handle=null;
    function renderTop(){
      txt('#tick', state.tick); txt('#tick-hours', state.tickHours);
      txt('#day', Math.ceil((state.simTime.getTime()-new Date(2025,0,1).getTime())/(24*3600*1000)));
      txt('#time', state.simTime.toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'}));
      txt('#balance-top', fmtEUR.format(state.balance));
      const clock=$('#clock'); if(clock) clock.classList.toggle('running', state.running);
    }
    function mockStep(){ state.tick++; state.simTime = new Date(state.simTime.getTime() + state.tickHours*3600*1000); state.balance -= 1.25; renderTop(); }
    function play(){ if(handle) return; state.running=true; renderTop(); handle=setInterval(mockStep, 800/state.speed); $('#btn-play').disabled=true; $('#btn-pause').disabled=false; }
    function pause(){ state.running=false; renderTop(); clearInterval(handle); handle=null; $('#btn-play').disabled=false; $('#btn-pause').disabled=true; }

    // ---------- Wiring -------------------------------------------------------
    function init(){
      // Ribbon switching
      $$('.rbtn').forEach(b=> b.addEventListener('click', ()=>{
        $$('.rbtn').forEach(x=>x.setAttribute('aria-pressed','false'));
        b.setAttribute('aria-pressed','true');
        state.treeMode = b.dataset.mode;
        // reset selection per mode
        state.level='none'; state.structureId=state.roomId=state.zoneId=state.plantId=null; state.finSel=state.shopSel=null;
        buildTree(); renderBreadcrumbs(); renderContent();
      }));

      buildTree();
      // default selection for structure
      selectNode('structure','s1');

      // search filter (mock)
      $('#search').addEventListener('input', e=>{
        const q=e.target.value.toLowerCase();
        $$('#tree .node .title').forEach(t=>{ const hit=t.textContent.toLowerCase().includes(q); t.closest('li').style.display=hit?'':''; });
      });
      $$('.chip').forEach(ch=>ch.addEventListener('click',()=>{ const on = ch.getAttribute('aria-pressed')==='true'; ch.setAttribute('aria-pressed', String(!on)); }));

      // sim controls
      $('#btn-step').addEventListener('click', mockStep);
      $('#btn-play').addEventListener('click', play);
      $('#btn-pause').addEventListener('click', pause);
      $$('.speed').forEach(b=>b.addEventListener('click',()=>{ state.speed=parseFloat(b.dataset.speed); $$('.speed').forEach(x=>x.setAttribute('aria-pressed', String(x===b))); if(handle){ pause(); play(); } }));

      renderTop();
      runTests();
    }
    document.addEventListener('DOMContentLoaded', init);

    // ---------- Lightweight Tests (console) ----------------------------------
    function test(name, fn){ try{ fn(); console.log('%c‚úî '+name, 'color:#34d399'); } catch(e){ console.error('‚úò '+name, e); } }
    function runTests(){
      test('Topbar zeigt Kontostand, Content hat KEINE Kontostand‚ÄëKarte', ()=>{
        if(!$('#balance-top')) throw new Error('balance-top fehlt');
        if($('#content .card h3')?.textContent?.includes('Kontostand')) throw new Error('Balance‚ÄëKarte im Content gefunden');
      });
      test('Zone hat Ger√§te‚ÄëGruppenknoten und keine Device‚ÄëLeafs im Tree', ()=>{
        // expand s1‚Üír1‚Üíz1 and check children types
        selectNode('structure','s1');
        const r1 = $(`#tree .node[data-kind="room"][data-id="r1"]`); r1?.click();
        const z1 = $(`#tree .node[data-kind="zone"][data-id="z1"]`); z1?.click();
        const z1li = z1?.closest('li');
        const hasGroup = z1li?.querySelector(`.node[data-kind="devices"][data-id="z1"]`);
        const hasLeaf = z1li?.querySelector(`.node[data-kind="device"]`);
        if(!hasGroup) throw new Error('Ger√§te‚ÄëGruppenknoten fehlt');
        if(hasLeaf) throw new Error('Es gibt Device‚ÄëLeafs ‚Äì sollen entfernt sein');
      });
      test('Klick auf Ger√§te‚ÄëGruppenknoten zeigt Devices‚ÄëTabelle im Content', ()=>{
        const devNode = $(`#tree .node[data-kind="devices"][data-id="z1"]`); devNode?.click();
        const hasTable = !!$('#content h3') && $('#content h3').textContent.includes('Devices');
        if(!hasTable) throw new Error('Devices‚ÄëDetails nicht im Content');
      });
      // Extra tests
      test('Breadcrumb enth√§lt Devices‚ÄëSegment', ()=>{
        const trail = $('#crumbs')?.textContent || '';
        if(!trail.includes('Devices')) throw new Error('Breadcrumb ohne Devices');
      });
      test('Devices‚ÄëTabelle hat Zeilen > 1', ()=>{
        const rows = $$('#content table tbody tr');
        if(!(rows && rows.length>1)) throw new Error('Zu wenige Zeilen in Devices‚ÄëTabelle');
      });
      test('Ribbon‚ÄëWechsel zu Finance setzt Content um', ()=>{
        const btn = $('#rb-finance'); btn?.click();
        const label = $('#crumbs strong')?.textContent || '';
        if(!label.includes('Finance Explorer')) throw new Error('Finance‚ÄëAnsicht nicht aktiv');
        // switch back to not affect manual use
        $('#rb-structure')?.click();
      });
    }
  </script>
</body>
</html>
